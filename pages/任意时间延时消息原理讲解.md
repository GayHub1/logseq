- #[[excerpt]] [任意时间延时消息原理讲解：设计与实现](https://mp.weixin.qq.com/s?__biz=MzU2NjIzNDk5NQ==&mid=2247486449&idx=1&sn=489b5e17521d2b961fa21e1e5be8a082&scene=21#wechat_redirect)
- tags: #[[SimpRead]]
- read date: [[2022_06_07  ]]
- desc: 这么骚的操作，的确不会，之前也没接触过，准备把去哪qmq里任意时间延迟消息这块源码好好研究下，搞明白！
- [📌](<http://localhost:7026/reading/8?title=任意时间延时消息原理讲解：设计与实现#id=1654566955824>)  如我们将消息按照一个小时为一个段，每次只加载一个段的消息到内存里。其实我们可以用一个很形象的比如来描述这种结构：两层时间轮 (hash wheel)。第一层 hash wheel 位于磁盘上，精度较粗，每个小时为 1 个刻度。第二层 hash wheel 位于内存里，只包含第一层 hash wheel 一个刻度的数据，精度为 1 秒。
- [📌](<http://localhost:7026/reading/8?title=任意时间延时消息原理讲解：设计与实现#id=1654567136049>)  我们按照每个时间段建立索引文件，那么如果我们不仅仅建立索引呢？也就是索引文件里不仅仅是索引，而是包括完整的消息：消息收到后先进入一个按照接收顺序的 log(qmq 里称之为 message log)，然后回放该 log，按照 log 里每条消息的投递时间将消息放到对应的时间段上 (qmq 里称之为 schedule log)，这样只要回放完成后 message log 里的消息就可以删除了，message log 只需要保留很少的内容，而 schedule log 是按照投递时间段来组织的，已经投递过的时间段也可以立即删除了。